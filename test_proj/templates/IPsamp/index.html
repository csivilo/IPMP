<!DOCTYPE HTML>
{% load staticfiles %}
<html>
    <title>IPMP</title>
    <head>
        <link rel="stylesheet" href='{%  static "js/webix/codebase/webix.css" %}' type="text/css">
        <script src="{%  static 'js/webix/codebase/webix.js' %}" type="text/javascript"></script>
        <script src="{%  static 'js/library.js' %}" type="text/javascript"></script>
        <script src="{%  static 'js/jquery-3.0.0.js' %}" type="text/javascript">

        </script>
    </head>
    
    <body>
    <script type="text/javascript" charset="utf-8">

        var data_points = [

            { id: 1, time_input: 0, conc_input:1},
            { id: 2, time_input: null, conc_input:null},
            { id: 3, time_input: null, conc_input:null},
            { id: 4, time_input: null, conc_input:null},
            { id: 5, time_input: null, conc_input:null},
            { id: 6, time_input: null, conc_input:null},
            { id: 7, time_input: null, conc_input:null},
            { id: 8, time_input: null, conc_input:null},
            { id: 9, time_input: null, conc_input:null},
            { id: 10, time_input: null, conc_input:null},
            { id: 11, time_input: null, conc_input:null},
            { id: 12, time_input: null, conc_input:null},
            { id: 13, time_input: null, conc_input:null},
            { id: 14, time_input: null, conc_input:null},
            { id: 15, time_input: null, conc_input:null},
            { id: 16, time_input: null, conc_input:null},
            { id: 17, time_input: null, conc_input:null},
            { id: 18, time_input: null, conc_input:null},
            { id: 19, time_input: null, conc_input:null},
            { id: 20, time_input: null, conc_input:null},
            { id: 21, time_input: null, conc_input:null},
            { id: 22, time_input: null, conc_input:null},
            { id: 23, time_input: null, conc_input:null},
            { id: 24, time_input: null, conc_input:null},
            { id: 25, time_input: null, conc_input:null},
            { id: 26, time_input: null, conc_input:null},
            { id: 27, time_input: null, conc_input:null},
            { id: 28, time_input: null, conc_input:null},
            { id: 29, time_input: null, conc_input:null},
            { id: 30, time_input: null, conc_input:null},
            { id: 31, time_input: null, conc_input:null},
            { id: 32, time_input: null, conc_input:null},
            { id: 33, time_input: null, conc_input:null}
        ];
        var updatedData = [];
        webix.ui({

            rows:[
                {view: "toolbar", height: 60, id:"main_toolbar", elements:[
                {view:"button", value:"Open", width:80 /*, click:file_options*/},
                {view:"button", value:"Paste", width:80 /* ,click:ipmp_disclaim*/},
                {view:"menu", data:[
                    {id: "models", value: "Models", width:200, height: 60, submenu:[
                        {id: "inc_models", value: "Incomplete", submenu:["Sub models"]},
                        {id: "full_models", value: "Full", submenu:[
                            {id: "gompertz", value: "Gompertz", click: "initialModel('Gompertz')"},
                            {id: "huang", value: "Huang", click: "plotModel('huang')"},
                            {id: "baranyi", value: "Baranyi", click: "plotModel('baranyi')"},
                            {id: "buchanan", value: "Buchanan", click: "plotModel('buchanan')"}
                        ]}
                   ]}
               ]},
               {view: "button" ,width:150, align: "right", value: "Plot"},
               {view: "button", width:150, align: "right", value: "Model Output", click: "initialModel('Gompertz')"}
               ]},
                {cols:[
                    {rows:[
                        {view: "datatable",
                        id: "input_table",
                        columns: [
                           {id: "time_input", editor: "text", header: "Time", width: 120},
                           {id: "conc_input", editor: "text", header: "Conc.", width: 100}],
                        editable: true,
                        height:250,
                        width:250,
                        data: data_points

                       // select: "cell",
                       // on: {'onMouseOut': function(){$$("input_table").unselect(data_points[data_points.length].id)}}
                        },

                        {view: "toolbar", id:"toolbar", elements:[
                            {view:"button", value:"Compute", width:80 , click:"computeData(); plotData()"},
                            {view:"button", value:"Plot Data", width:80 , click:"plotData(); printData(); dataIsValid()"},
                            {view:"button", value:"Submit Data", width:100 , click:"computeData()"},
                            {view:"button", value:"Clear Data", width:100 , click:"clearData()"}


                        ]},
                        {rows:[
						    {view:"form", id:"slider_input", height: 160,elements:[
                                { view:"slider",  height: 20, type:"alt", min:0, max:5, label:"N0(0-5)", value:"0", name:"s1"},
                                { view:"slider", height: 20, type:"alt", min:0, max:9, label:"NMax(0-9)", value:"0", name:"s2"},
                                { view:"slider", height: 20, type:"alt", min:0, max:5, label:"Rate(0-5)", value:"0", name:"s3"},
                                { view:"slider", height: 20, type:"alt",  label:"Time", value:"0", name:"s4"},
                                { view:"slider", height: 20, type:"alt",  label:"M", value:"0", name:"s5"}
						    ]},
						    {view:"form", id:"insert_input", elements:[{
                                type: "clean",
                                rows: [
                                    {
                                        view: "fieldset", label: "Data", body: {
                                        rows: [
                                            {view: "text", id: "nO", label: "N0", value: "0", name: "s1"},
                                            {view: "text", id: "nmax", label: "NMax", value: "0", name: "s2"},
                                            {view: "text", id: "rate", label: "Rate", value: "0", name: "s3"},
                                            {view: "text", id: "time", label: "Time", value: "0", name: "s4"},
                                            {view: "text", id: "m", label: "M", value: "0", name: "s5"}
                                        ]
                                    }
                                    },
                                    {
                                        cols: [
                                            {
                                                view: "button",
                                                type: "form",
                                                id: "slider_set",
                                                label: "Set values",
                                                click: "set(); getData()",
                                                align: "right",
                                                width: 90
                                            },
                                            {
                                                view: "button",
                                                id: "slider_get",
                                                label: "Get values",
                                                click: "get(); getData()",
                                                align: "left",
                                                width: 90
                                            }
                                        ]
                                    },
                                    {
                                        view: "button",
                                        type: "form",
                                        id: "model_submit",
                                        label: "Model Submit",
                                        click: ""
                                    }
                                ]
                            }]
                            }

                        ]}
                    ]},
                    {rows:[
                        {view:"chart",
                        id: "data_chart",
                        type:"spline",
                        yValue:"#conc_input#",
                        origin: 0,
                        yAxis:{
                            title:"Log Concentration of Bacteria"
                        },
                        xAxis:{
                            title:"Time (h)",
                            template: "#time_input#"
                        },
                        line:{
                            color: "#1293f8"
                        },
                        item:{
                            radius:.01,
                            color:"#1293f8",
                            type:"c",
                            shadow:false
                        },
                        data: updatedData,

                        isVisible:false
                        },

                        {view: "toolbar", elements:[
                            {view: "button", width: 100, align: "right",  label: "Save Report" },
                            {view: "button", width: 100, align: "right",   label: "Print Report" }
                        ]},
                        {view: "datatable",
                            id:"output_table",
                            columns: [
                               {id: "report_table", header: "Report" }
                            ],
                            editable: false

                        }
                    ]}

                ]}
            ]
        });


        //checks to see if you data points has valid input
        function dataIsValid(){
            var min = data_points[0].conc_input;
            var popBox = true;
            var max = data_points[data_points.length - 1].conc_input;
            $$('input_table').editStop(); //makes editing stop so the last value is properly put in data_points

            for(var i = 0; i < data_points.length; i++){
                //if both inputs are null, we assume user doesnt want to add it to the list of data
                if(data_points[i].conc_input == null && data_points[i].time_input == null){
                    continue;
                }
                //converts the strings to floats, if not valid floats they evaluate to NaN
                var timeValid = parseFloat(data_points[i].time_input); //x
                var conValid = parseFloat(data_points[i].conc_input); //y

                if(!isInt(timeValid)){ //if timeValid is not valid input
                    webix.alert({
                            type: "alert-warning",
                            text: "Warning! The data contains at least one non-numeric entry. Please verify!"
                    });
                    popBox = false;
                    $$('input_table').addCellCss(data_points[i].id, "time_input", "my_style");
                    break;
                }
                else if(!isInt(conValid)){ //if conc input isnt valid, have them verify

                    webix.alert({
                            type: "alert-warning",
                            text: "Warning! The data contains at least one non-numeric entry. Please verify!"
                    });
                    popBox = false;
                    $$('input_table').addCellCss(data_points[i].id, "conc_input", "my_style");
                    break;

                } else{ //if there are no issues, clear the background error color
                    $$('input_table').addCellCss(data_points[i].id, "time_input", "no_style");
                    $$('input_table').addCellCss(data_points[i].id, "conc_input", "no_style");
                }

                //determines the min and max values to be used later to determine if y values are in log or ln
                if(conValid < min){
                    min = conValid;
                }
                if(conValid > max){
                    max = conValid;
                }
            }
            //we only want to alert one box at a time
            //if true, we want to display the following warning and convert if necessary
            if(popBox == true){
                //check if the Y value is within the correct range and alert if it isn't
                if(min < 6.0 && max < 10.0){
                    webix.confirm({
                        ok: "Yes",
                        cancel: "No",
                        type: "confirm-error",
                        text: "Warning!- The colony counts appear to be in log CFU. They must be converted to ln " +
                            "CFU for data analysis. Do you want to convert data to ln CFU?",
                        callback: function(result){
                            //if they clicked ok ("yes")
                            if(result === true){
                                convert(); //converts data to ln
                               // plotData();//plots the data
                            }
                        }
                    });
                }
            }

        }

        //if it is an int or null or float value, return true, otherwise false
        function isInt(n){
            //if it evaluates to NaN, it must have been a string
            if(isNaN(n) || n == null){
                return false;
            }
           //was not a string, if it's correct input, return true
            else if(typeof n == 'number' && Math.round(n) % 1 == 0 ) {
                return true;
            }
            //default is false
            return false;
        }

        //will convert from log to ln
        function convert(){
            for(var i = 0; i < data_points.length; i++){
                if(data_points[i].conc_input == null && data_points[i].time_input == null){
                    continue;
                }
                data_points[i].conc_input *= 2.303; //multiply by 2.303 puts the data into ln form
            }
            $$('input_table').refresh();
        }



    </script>


    </body>
    <style type = "text/css">
        .my_style{
            background: #ff7b82;
        }
        .no_style{
            background: #ffffff;
        }
    </style>
</html>
